<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agent Dashboard</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    header {
      display: flex; justify-content: space-between; align-items: center;
      background: #333; color: white; padding: 10px 20px;
      position: relative;
    }
    nav { display: flex; gap: 15px; }
    nav a {
      color: white; text-decoration: none; font-weight: bold;
    }
    nav a:hover { text-decoration: underline; }

    .bell {
      position: relative; font-size: 22px; cursor: pointer;
    }
    .badge {
      position: absolute; top: -8px; right: -10px;
      background: red; color: white; border-radius: 50%;
      padding: 2px 6px; font-size: 12px; display: none;
    }
    .dropdown {
      display: none;
      position: absolute; right: 20px; top: 60px;
      background: white; width: 320px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      border-radius: 8px; overflow: hidden;
      z-index: 999;
    }
    .dropdown.active { display: block; }
    .notification {
      padding: 10px; border-bottom: 1px solid #ddd; cursor: pointer;
    }
    .notification strong { color: #0073e6; display: block; margin-bottom: 5px; }
    .notification button {
      margin-top: 6px; padding: 5px 10px;
      background: #0073e6; color: white; border: none;
      border-radius: 4px; cursor: pointer; font-size: 12px;
    }
    .notification button:hover { background: #005bb5; }
  </style>
</head>
<body>
  <header>
    <div class="logo">Agent Dashboard</div>
    <nav>
      <a href="agent.html">Home</a>
      <a href="notification.html">Notifications</a>
      <a href="profile.html">Profile</a>
      <a href="#" onclick="logout()">Logout</a>
    </nav>

    <div class="bell" onclick="handleBellClick()">
      ðŸ”” <span id="badge" class="badge">0</span>
    </div>
  </header>

  <div id="dropdown" class="dropdown"></div>

  <!-- Sound -->
  <audio id="dingSound" preload="auto">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.mp3" type="audio/mpeg">
  </audio>
  <script>
    // --- Logout ---
    function logout() {
      localStorage.removeItem("username"); // only clear login, keep notifications
      window.location.href = "login.html";
    }

    // --- Notifications ---
    const API_URL = "https://script.google.com/macros/s/AKfycbxsqetZ_iRLnZ3mhRcbxX09q4c0aXU_xHzO5JaPkocr0syDM52DsPsGI-raZi2GCpl5/exec";
    let unread = JSON.parse(localStorage.getItem("unread") || "[]");
    let lastSeenTime = localStorage.getItem("lastSeenTime") ? new Date(localStorage.getItem("lastSeenTime")) : null;

    function saveState() {
      localStorage.setItem("unread", JSON.stringify(unread));
      if (lastSeenTime) {
        localStorage.setItem("lastSeenTime", lastSeenTime.toISOString());
      }
    }

    function handleBellClick() {
      const badge = document.getElementById("badge");
      if (badge.style.display === "none" || badge.innerText === "0") {
        window.location.href = "all.html"; // no unread â†’ go to all.html
      } else {
        document.getElementById("dropdown").classList.toggle("active");
      }
    }

    async function fetchNotifications() {
      try {
        const res = await fetch(API_URL);
        let data = await res.json();

        data.sort((a,b)=> new Date(b.Timestamp) - new Date(a.Timestamp));

        if (!lastSeenTime && data.length > 0) {
          lastSeenTime = new Date(data[0].Timestamp);
          saveState();
          return;
        }

        let newOnes = data.filter(n => new Date(n.Timestamp) > lastSeenTime);

        if (newOnes.length > 0) {
          document.getElementById("dingSound").play().catch(()=>{});
          unread = [...newOnes, ...unread].slice(0, 5);
          lastSeenTime = new Date(newOnes[0].Timestamp);
          updateUI();
          saveState();
        }
      } catch(err) {
        console.error("Fetch error", err);
      }
    }

    function updateUI() {
      const badge = document.getElementById("badge");
      const dropdown = document.getElementById("dropdown");

      if (unread.length > 0) {
        badge.innerText = unread.length;
        badge.style.display = "inline";
      } else {
        badge.style.display = "none";
      }

      dropdown.innerHTML = "";
      unread.forEach((n, idx) => {
        const div = document.createElement("div");
        div.className = "notification";
        div.innerHTML = `
          <strong>ðŸ”” New Notification</strong>
          <div>"${n.Message}"</div>
          <div>From: ${n.From} | Agent: ${n.Agent}</div>
          <button>See more...</button>
        `;

        // click on card â†’ remove (mark as read)
        div.addEventListener("click", () => {
          unread.splice(idx, 1);
          updateUI();
          saveState();
        });

        // button â†’ go to all.html
        div.querySelector("button").addEventListener("click", (e) => {
          e.stopPropagation();
          window.location.href = "all.html";
        });

        dropdown.appendChild(div);
      });
    }

    // init
    updateUI();
    fetchNotifications();
    setInterval(fetchNotifications, 10000);
  </script>
</body>
</html>
