<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Notification Bell</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; }
    .navbar {
      background: #0073e6; color: white; padding: 12px 20px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .bell {
      position: relative; font-size: 22px; cursor: pointer;
    }
    .badge {
      position: absolute; top: -8px; right: -10px;
      background: red; color: white; border-radius: 50%;
      padding: 2px 6px; font-size: 12px;
    }
    .dropdown {
      display: none;
      position: absolute; right: 20px; top: 50px;
      background: white; width: 320px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      border-radius: 8px; 
      overflow-y: auto;       /* enable vertical scroll */
      max-height: 60vh;       /* limit height to 60% of screen */
      z-index: 999;
    }
    .dropdown.active { display: block; }
    .notification {
      padding: 10px; border-bottom: 1px solid #ddd;
      cursor: pointer;
    }
    .notification strong { color: #0073e6; display: block; margin-bottom: 5px; }
    .notification button {
      margin-top: 6px; padding: 5px 10px;
      background: #0073e6; color: white; border: none;
      border-radius: 4px; cursor: pointer; font-size: 12px;
    }
    .notification button:hover { background: #005bb5; }
  </style>
</head>
<body>
  <div class="navbar">
    <h2>My App</h2>
    <div class="bell" onclick="handleBellClick()">
      ðŸ”” <span id="badge" class="badge" style="display:none">0</span>
    </div>
  </div>

  <div id="dropdown" class="dropdown"></div>

  <!-- Sound for notifications -->
  <audio id="dingSound" preload="auto">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.mp3" type="audio/mpeg">
  </audio>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxsqetZ_iRLnZ3mhRcbxX09q4c0aXU_xHzO5JaPkocr0syDM52DsPsGI-raZi2GCpl5/exec";

    let unread = JSON.parse(localStorage.getItem("unread") || "[]");
    let lastSeenTime = localStorage.getItem("lastSeenTime") ? new Date(localStorage.getItem("lastSeenTime")) : null;

    function saveState() {
      localStorage.setItem("unread", JSON.stringify(unread));
      if (lastSeenTime) {
        localStorage.setItem("lastSeenTime", lastSeenTime.toISOString());
      }
    }

    function handleBellClick() {
      const badge = document.getElementById("badge");
      if (badge.style.display === "none" || badge.innerText === "0") {
        // No unread â†’ go to all.html
        window.location.href = "all.html";
      } else {
        // Toggle dropdown
        document.getElementById("dropdown").classList.toggle("active");
      }
    }

    async function fetchNotifications() {
      try {
        const res = await fetch(API_URL);
        let data = await res.json();

        // sort newest first
        data.sort((a,b)=> new Date(b.Timestamp) - new Date(a.Timestamp));

        if (!lastSeenTime && data.length > 0) {
          // first load: set lastSeenTime but do not trigger sound
          lastSeenTime = new Date(data[0].Timestamp);
          saveState();
          return;
        }

        let newOnes = data.filter(n => new Date(n.Timestamp) > lastSeenTime);

        if (newOnes.length > 0) {
          // play sound once for new arrivals
          document.getElementById("dingSound").play().catch(()=>{});
          
          // prepend new ones
          unread = [...newOnes, ...unread];

          // update last seen time to newest
          lastSeenTime = new Date(newOnes[0].Timestamp);

          updateUI();
          saveState();
        }
      } catch(err) {
        console.error("Fetch error", err);
      }
    }

    function updateUI() {
      const badge = document.getElementById("badge");
      const dropdown = document.getElementById("dropdown");

      if (unread.length > 0) {
        badge.innerText = unread.length;
        badge.style.display = "inline";
      } else {
        badge.style.display = "none";
      }

      dropdown.innerHTML = "";
      unread.forEach((n, idx) => {
        const div = document.createElement("div");
        div.className = "notification";
        div.innerHTML = `
          <strong>ðŸ”” New Notification</strong>
          <div>"${n.Message}"</div>
          <div>From: ${n.From} | Agent: ${n.Agent}</div>
          <button>See more...</button>
        `;

        // click on card removes it
        div.addEventListener("click", () => {
          unread.splice(idx, 1);
          updateUI();
          saveState();
        });

        // prevent button from removing notification, go to all.html
        div.querySelector("button").addEventListener("click", (e) => {
          e.stopPropagation();
          window.location.href = "all.html";
        });

        dropdown.appendChild(div);
      });
    }

    // restore UI from storage on load
    updateUI();

    // initial fetch
    fetchNotifications();
    // poll every 10s
    setInterval(fetchNotifications, 10000);
  </script>
</body>
</html>
